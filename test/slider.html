<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Compare Slider</title>
</head>
<body>

    <image-comparison thumb-color="#000">
        <img slot="image1" src="./img/japan-2011-after.jpg" alt="">
        <img slot="image2" src="./img/japan-2011-before.jpg" alt="">
    </image-comparison>


    <image-comparison thumb-color="#fff">
        <img slot="image1" width="500" height="500" src="https://images.unsplash.com/photo-1718819616289-fa0e80c23978?q=80&w=3087&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="">
        <img slot="image2" width="500" height="500" src="https://images.unsplash.com/photo-1718819807268-56bb797822f0?q=80&w=2792&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="">
    </image-comparison>    
    <p>
        Lorem ipsum, dolor sit amet consectetur adipisicing elit. Repellendus fugiat debitis porro ea dolore sapiente obcaecati nostrum iure dolores quaerat.
    </p>

    <image-comparison thumb-color="#fff">
        <img slot="image1" width="500" height="500" src="https://images.unsplash.com/photo-1718819616289-fa0e80c23978?q=80&w=3087&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="">
        <img slot="image2" width="500" height="500" src="https://images.unsplash.com/photo-1718819807268-56bb797822f0?q=80&w=2792&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="">
    </image-comparison>   
    
    <script>
        class ImageComparison extends HTMLElement {
            constructor() {
                super();
                this.clicked = false;
            }

            connectedCallback() {
                const shadow = this.attachShadow({ mode: 'open' });
                const thumbColor = this.getAttribute('thumb-color') || '#2196F3';
                const slot1 = this.querySelector('img[slot="image1"]');
                const slot2 = this.querySelector('img[slot="image2"]');
                const slot1Height = slot1.getAttribute('height') || 500;
                const slot2Height = slot2.getAttribute('height') || 500,
                slot1Width = slot1.getAttribute('width') || 500,
                slot2Width = slot2.getAttribute('width') || 500;


                shadow.innerHTML = `
                    <style>
                        * {box-sizing: border-box;}
                        .img-comp-container {
                            position: relative;
                            min-height: ${slot1Height > slot2Height ? slot1Height : slot2Height}px;
                        }
                        .img-comp-img {
                            position: absolute;
                            width: auto;
                            height: auto;
                            overflow: hidden;
                        }
                        ::slotted(img) {
                            display: block;
                            object-fit: cover;
                            width: ${slot1Width}px;
                            height: ${slot1Height}px;
                        }
                        .img-comp-slider {
                            position: absolute;
                            z-index: 9;
                            cursor: ew-resize;
                            width: 40px;
                            height: 40px;
                            background-color: ${thumbColor};
                            opacity: 0.8;
                            border-radius: 50%;
                        }
                    </style>
                    <div class="img-comp-container">
                        <div class="img-comp-img">
                            <slot name="image1"></slot>
                        </div>
                        <div class="img-comp-img img-comp-overlay">
                            <slot name="image2"></slot>
                        </div>
                    </div>
                `;

                this.initComparisons();
            }

            initComparisons() {
                const overlays = this.shadowRoot.querySelectorAll(".img-comp-overlay");
                overlays.forEach(img => this.compareImages(img));
            }

            compareImages(img) {
                const container = img.closest('.img-comp-container');
                const w = container.offsetWidth;
                const h = container.offsetHeight;

                img.style.width = (w / 2) + "px";

                const slider = document.createElement("div");
                slider.setAttribute("class", "img-comp-slider");
                container.insertBefore(slider, img);

                // Position the slider in the middle
                slider.style.top = (h / 2) - (slider.offsetHeight / 2) + "px";
                slider.style.left = (w / 2) - (slider.offsetWidth / 2) + "px";

                const mouseDownHandler = (e) => this.slideReady(e, slider, img, w);
                const mouseUpHandler = () => this.slideFinish();
                const mouseMoveHandler = (e) => this.slideMove(e, slider, img, w);

                slider.addEventListener("mousedown", mouseDownHandler);
                window.addEventListener("mouseup", mouseUpHandler);
                window.addEventListener("mousemove", mouseMoveHandler);

                slider.addEventListener("touchstart", mouseDownHandler);
                window.addEventListener("touchend", mouseUpHandler);
                window.addEventListener("touchmove", mouseMoveHandler);

                // Store references to these handlers for later removal
                this.mouseMoveHandler = mouseMoveHandler;
                this.mouseUpHandler = mouseUpHandler;
                this.mouseDownHandler = mouseDownHandler;
            }

            slideReady(e, slider, img, w) {
                e.preventDefault();
                this.clicked = true;
            }

            slideFinish() {
                this.clicked = false;
            }

            slideMove(e, slider, img, w) {
                if (!this.clicked) return;
                let pos = this.getCursorPos(e, img);
                const container = img.closest('.img-comp-container');
                const containerRect = container.getBoundingClientRect();

                // Ensure pos.x is relative to the container
                pos.x = e.clientX - containerRect.left;

                // Set boundaries
                if (pos.x < 0) pos.x = 0;
                if (pos.x > containerRect.width) pos.x = containerRect.width;

                // Set image width
                img.style.width = pos.x + "px";

                // Adjust slider position
                const sliderPos = pos.x - (slider.offsetWidth / 2);
                slider.style.left = Math.max(0, Math.min(sliderPos, containerRect.width - slider.offsetWidth)) + "px";
            }

            getCursorPos(e) {
                e = e.changedTouches ? e.changedTouches[0] : e;
                return { x: e.clientX };
            }

            disconnectedCallback() {
                window.removeEventListener("mousemove", this.mouseMoveHandler);
                window.removeEventListener("touchmove", this.mouseMoveHandler);
                window.removeEventListener("mouseup", this.mouseUpHandler);
                window.removeEventListener("touchend", this.mouseUpHandler);
            }
        }

        customElements.define('image-comparison', ImageComparison);
    </script>
</body>
</html>
